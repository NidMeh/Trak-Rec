<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Trak Recovery</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071018; --card:#0d1418; --muted:#9aa6b2; --accent:#38e6c6;
    --danger:#ff6b6b; --glass: rgba(255,255,255,0.02); --glass-2: rgba(255,255,255,0.03);
    --shadow: 0 8px 30px rgba(2,6,10,0.6);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; padding:18px; background:linear-gradient(180deg,var(--bg),#041018 160%);
    color:#e9f5f2; -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale; display:flex; justify-content:center;
  }
  .wrap{width:100%;max-width:760px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,#072a2a,#0b1b2a);display:grid;place-items:center;box-shadow:var(--shadow)}
  .logo svg{width:30px;height:30px;opacity:.95}
  .title{font-size:18px;font-weight:700;margin:0}
  .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
  .mode-pill{background:var(--glass);padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600;font-size:13px}

  main.card{background:linear-gradient(180deg,var(--card),#07121a);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .row{display:flex;gap:12px;align-items:center}
  .col{display:flex;flex-direction:column}
  .big{font-size:44px;font-weight:700;line-height:1}
  .label{color:var(--muted);font-size:13px}
  .muted{color:var(--muted)}
  .xp-bar{height:14px;background:var(--glass);border-radius:999px;overflow:hidden;margin-top:10px}
  .xp-fill{height:100%;background:linear-gradient(90deg,var(--accent),#7feed7);width:0;transition:width .5s}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  button.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:10px;color:#e9f5f2;font-weight:700;cursor:pointer}
  button.primary{background:linear-gradient(90deg,#03bfa3,#19d2b0);color:#04221f;border:none}
  button.warn{background:linear-gradient(90deg,#b84343,#e04b4b);color:white;border:none}
  input[type="date"], textarea, input[type="text"], select{background:#061018;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:#dff8f1;width:100%;outline:none}
  textarea{min-height:88px;resize:vertical}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .compact{background:var(--glass);padding:12px;border-radius:10px}
  .footer{display:flex;gap:8px;justify-content:space-between;margin-top:12px}
  .tab{flex:1;padding:10px 8px;border-radius:10px;text-align:center;background:transparent;border:1px solid transparent;color:var(--muted);font-weight:700}
  .tab.active{background:linear-gradient(90deg,#062b2a,#072426);color:var(--accent);border:1px solid rgba(255,255,255,0.03)}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(2,6,10,0.8));z-index:80;padding:18px}
  .modal .panel{width:100%;max-width:720px;background:linear-gradient(180deg,#071217,#061219);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .item{background:var(--glass-2);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
  .muted-sm{color:var(--muted);font-size:13px}

  .milestone-road{display:flex;flex-direction:column;gap:8px}
  .ms-row{display:flex;gap:12px;align-items:center}
  .ms-pill{min-width:60px;padding:8px 10px;border-radius:8px;text-align:center;font-weight:700}
  .ms-locked{background:rgba(255,255,255,0.02);color:var(--muted)}
  .ms-unlocked{background:linear-gradient(90deg,#1bbf98,#38e6c6);color:#021b18}

  .center{display:grid;place-items:center}
  .small{font-size:13px;padding:8px 10px}
  .danger{color:var(--danger)}
  .ok{color:var(--accent)}
  .mini{font-size:13px;color:var(--muted)}

  @media (max-width:600px){
    .grid{grid-template-columns:1fr}
    .big{font-size:36px}
    header{flex-direction:column;align-items:flex-start;gap:8px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- simple vector mark -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="5" fill="#fff" opacity="0.03"/><path d="M6 13c2-3 5-5 8-5 3 0 4 2 4 4" stroke="#7ef1df" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div>
          <div class="title">Trak Recovery</div>
          <div class="subtitle">Real milestones • XP • Journal</div>
        </div>
      </div>
      <div class="mode-pill">Recovery</div>
    </header>

    <main class="card" id="homeCard">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="label">Current Streak</div>
          <div class="big" id="currentStreak">0</div>
          <div class="mini">Highest: <span id="highestStreak">0</span> • Total clean: <span id="totalClean">0</span></div>
        </div>

        <div style="text-align:right;min-width:150px">
          <div class="label">Level</div>
          <div class="big" id="levelNum">1</div>
          <div class="muted-sm">XP: <span id="xpCount">0</span> / <span id="xpGoal">0</span></div>
        </div>
      </div>

      <div class="xp-bar" role="progressbar" aria-label="XP progress">
        <div class="xp-fill" id="xpFill"></div>
      </div>

      <div class="controls">
        <div style="display:flex;gap:8px;align-items:center;flex:1;min-width:220px">
          <input type="date" id="logDate" />
          <button class="btn primary" id="btnLogClean">Log Clean Day</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center;min-width:220px">
          <input type="date" id="relapseDate"/>
          <button class="btn warn" id="btnRelapse">Log Relapse</button>
        </div>
      </div>

      <div class="grid">
        <div class="compact center">
          <div class="muted">Emergency</div>
          <div style="height:8px"></div>
          <button class="btn" id="btnEmergency">Open Emergency</button>
        </div>

        <div class="compact center">
          <div class="muted">Urge Timer</div>
          <div style="height:8px"></div>
          <button class="btn" id="btnUrge">Start Urge Timer</button>
          <div class="mini" style="margin-top:8px">Last: <span id="lastUrge">—</span></div>
        </div>
      </div>

      <div class="grid">
        <div class="compact">
          <div class="label">Quick Journal (optional)</div>
          <textarea id="journalText" placeholder="Write how you felt today..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn primary" id="btnSaveJournal">Save</button>
            <button class="btn" id="btnViewJournals">View Journals</button>
          </div>
        </div>

        <div class="compact">
          <div class="label">Stats Snapshot</div>
          <div class="list" style="margin-top:10px">
            <div class="item"><div>Total clean</div><div id="statTotal">0</div></div>
            <div class="item"><div>Relapses</div><div id="statRelapses">0</div></div>
            <div class="item"><div>Milestones unlocked</div><div id="statMilestones">0</div></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="btnOpenMilestones">Open Milestones</button>
            <button class="btn" id="btnOpenStats">Open Stats</button>
          </div>
        </div>
      </div>
    </main>

    <div class="footer">
      <button class="tab active" id="tabHome">Home</button>
      <button class="tab" id="tabMilestones">Milestones</button>
      <button class="tab" id="tabJournal">Journal</button>
      <button class="tab" id="tabSettings">Settings</button>
    </div>

  </div>

  <!-- Modal: Emergency -->
  <div class="modal" id="modalEmergency">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Emergency Mode</strong><div class="muted-sm">Quick tools to ride urges</div></div>
        <div><button class="btn" id="closeEmergency">Close</button></div>
      </div>
      <div style="height:12px"></div>
      <div style="display:flex;gap:12px;flex-direction:column;align-items:center">
        <div class="breath-box center" style="width:220px;height:220px;border-radius:14px;background:linear-gradient(180deg,#06131a,#042026);">
          <div class="breath-ring" id="breathRing" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(90deg,#38e6c6,#9ffbe9);opacity:.1;transition:transform .35s ease"></div>
          <div class="muted-sm" id="breathText" style="margin-top:12px">Tap start to breathe</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn primary" id="startBreath">Start Breathing</button>
          <button class="btn" id="stopBreath">Stop</button>
          <button class="btn" id="quickQuote">Motivation</button>
        </div>
        <div style="margin-top:10px" class="muted-sm">Quotes: <em>Urges pass. Breathe. You build new pathways.</em></div>
      </div>
    </div>
  </div>

  <!-- Modal: Milestones -->
  <div class="modal" id="modalMilestones">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Milestones Roadmap</strong><div class="muted-sm">Realistic recovery stages + rewards</div></div>
        <div><button class="btn" id="closeMilestones">Close</button></div>
      </div>
      <div class="list milestone-road" id="milestoneList" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Modal: Milestone Unlock -->
  <div class="modal" id="modalMilestoneUnlock">
    <div class="panel center">
      <div style="font-size:20px;font-weight:700" id="unlockTitle">Milestone!</div>
      <div class="muted-sm" id="unlockDesc" style="margin-top:8px"></div>
      <div style="height:12px"></div>
      <div class="muted-sm" id="unlockReality"></div>
      <div style="height:12px"></div>
      <button class="btn primary" id="closeUnlock">Nice</button>
    </div>
  </div>

  <!-- Modal: Stats -->
  <div class="modal" id="modalStats">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Stats</strong><div class="muted-sm">Progress overview</div></div>
        <div><button class="btn" id="closeStats">Close</button></div>
      </div>
      <div class="list" id="statsList" style="margin-top:12px"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn warn" id="btnResetApp">Reset App (wipe all data)</button>
        <button class="btn" id="btnExport">Export Data</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none"/>
        <button class="btn" id="btnImport">Import Data</button>
      </div>
    </div>
  </div>

  <!-- Modal: Journal List -->
  <div class="modal" id="modalJournals">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Journals</strong><div class="muted-sm">Tap to edit an entry</div></div>
        <div><button class="btn" id="closeJournals">Close</button></div>
      </div>
      <div class="list" id="journalList" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/* Trak Recovery v2 - single-file app
   - localStorage key: trak_recovery_v2
   - features: streak, milestones, xp+level (xp resets each level), journal, urge timer, emergency breathing, export/import, full reset
*/

// ---------- Storage & State ----------
const STORAGE_KEY = 'trak_recovery_v2';
const defaultState = {
  cleanDates: [],      // YYYY-MM-DD
  relapseDates: [],    // YYYY-MM-DD
  journal: {},         // date => text
  level: 1,
  xp: 0,               // xp in current level (resets each level)
  unlocked: [],        // milestone.days unlocked
  urgeLogs: [],        // {date, seconds}
  highestStreak: 0
};
let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return {...defaultState};
    const parsed = JSON.parse(raw);
    return {...defaultState, ...parsed};
  }catch(e){
    console.error('load error',e);
    return {...defaultState};
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ---------- Helpers ----------
function todayKey(d=new Date()){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function parseKeyToDate(k){ return new Date(k + 'T00:00:00'); }
function addUnique(arr, val){ if (!arr.includes(val)) arr.push(val); arr.sort(); return arr; }
function uniqueSorted(arr){ return Array.from(new Set(arr)).sort(); }

// ---------- Milestones (hybrid realistic + game) ----------
const MILESTONES = [
  {day:1, title:"The First Step", reality:"Commitment made. Initial withdrawal & cravings are common.", xpBonus:10},
  {day:3, title:"Breaking Pattern", reality:"Dopamine down, fog may appear; you're adjusting.", xpBonus:15},
  {day:7, title:"Forging Focus", reality:"First strong wave of urges; routine helps you pass it.", xpBonus:25},
  {day:10, title:"Steady Mind", reality:"Mood swings ease; small clear pockets appear.", xpBonus:20},
  {day:14, title:"Regained Control", reality:"More consistent focus, better social presence.", xpBonus:30},
  {day:21, title:"The Flatline", reality:"Libido may feel muted — this is a normal reset phase.", xpBonus:20},
  {day:30, title:"Body Awakens", reality:"Energy stabilizes; sensitivity begins to return for many.", xpBonus:40},
  {day:45, title:"Temptation Weakens", reality:"Urges shorter and easier to ride out.", xpBonus:50},
  {day:60, title:"Real Attraction Returns", reality:"Real people feel more attractive than screens.", xpBonus:80},
  {day:90, title:"Rewired", reality:"Thoughts about porn are distant; stronger clarity.", xpBonus:120},
  {day:120, title:"Solid Ground", reality:"Urges are manageable; motivation increases.", xpBonus:160},
  {day:150, title:"Deep Healing", reality:"Sensitivity near-normal; consistent morning erections for many.", xpBonus:200},
  {day:180, title:"True Baseline", reality:"Reward pathways largely reset; urges are short-lived.", xpBonus:300},
  {day:365, title:"Self-Mastery", reality:"Long-term freedom; regained sexual health and control.", xpBonus:600}
];

// ---------- Leveling: xp goal per level (resets each level) ----------
function xpGoalForLevel(level){
  // progressively harder goals; tweakable
  return Math.round(30 * Math.pow(1.6, level-1));
}

// ---------- Streak calculations ----------
function computeCurrentStreak(){
  const s = new Set(state.cleanDates);
  if (!s.size) return 0;
  const sorted = state.cleanDates.slice().sort();
  const latest = sorted[sorted.length - 1];
  let count = 0;
  let cur = parseKeyToDate(latest);
  while(true){
    const key = todayKey(cur);
    if (s.has(key)){ count++; cur = new Date(cur.getTime() - 24*60*60*1000); }
    else break;
  }
  return count;
}
function computeHighestStreak(){
  const s = new Set(state.cleanDates);
  if (!s.size) return 0;
  const sorted = state.cleanDates.slice().sort();
  let best = 0;
  for (let i=0;i<sorted.length;i++){
    let run = 0; let cur = parseKeyToDate(sorted[i]);
    while(s.has(todayKey(cur))){ run++; cur = new Date(cur.getTime() + 24*60*60*1000); }
    if (run>best) best = run;
    i += run - 1;
  }
  return best;
}

// ---------- Actions ----------
function logClean(dateKey){
  dateKey = dateKey || todayKey();
  if (!state.cleanDates.includes(dateKey)){
    state.cleanDates = addUnique(state.cleanDates, dateKey);
    state.xp = Math.max(0, state.xp + 10); // daily XP
    checkLevelUp();
    checkMilestones();
    state.highestStreak = Math.max(state.highestStreak, computeHighestStreak());
    saveState();
    renderAll();
    return true;
  }
  return false;
}

function logRelapse(dateKey){
  dateKey = dateKey || todayKey();
  if (!state.relapseDates.includes(dateKey)) state.relapseDates = addUnique(state.relapseDates, dateKey);
  // remove any clean days >= relapse day (they're invalid after relapse)
  state.cleanDates = state.cleanDates.filter(d => d < dateKey);
  // penalty
  state.xp = Math.max(0, state.xp - 20);
  saveState();
  renderAll();
}

function saveJournal(dateKey, text){
  if (!text || !text.trim()) delete state.journal[dateKey];
  else state.journal[dateKey] = text.trim();
  saveState();
  renderAll();
}

function saveUrge(seconds){
  state.urgeLogs.push({date: todayKey(), seconds});
  saveState();
  renderAll();
}

// level up logic: xp resets each level (we subtract current goal and increase level)
function checkLevelUp(){
  let goal = xpGoalForLevel(state.level);
  while (state.xp >= goal){
    state.xp -= goal;
    state.level++;
    goal = xpGoalForLevel(state.level);
    // show level up (small modal)
    showUnlock(`Level Up!`, `You reached Level ${state.level}. New goal: ${goal} XP.`);
  }
  saveState();
}

// milestones check/unlock
function checkMilestones(){
  const streak = computeCurrentStreak();
  MILESTONES.forEach(ms => {
    if (streak >= ms.day && !state.unlocked.includes(ms.day)){
      state.unlocked.push(ms.day);
      state.xp = Math.max(0, state.xp + (ms.xpBonus || 0)); // award xp in current level
      showUnlock(ms.title, `Reward: +${ms.xpBonus || 0} XP\n\n${ms.reality}`);
      checkLevelUp();
    }
  });
  state.unlocked = uniqueSorted(state.unlocked);
  saveState();
}

// ---------- UI rendering ----------
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

function renderAll(){
  const streak = computeCurrentStreak();
  $('#currentStreak').textContent = streak;
  $('#highestStreak').textContent = state.highestStreak || computeHighestStreak();
  $('#totalClean').textContent = state.cleanDates.length;
  $('#levelNum').textContent = state.level;
  const goal = xpGoalForLevel(state.level);
  $('#xpCount').textContent = state.xp;
  $('#xpGoal').textContent = goal;
  const pct = Math.min(100, Math.round(state.xp / goal * 100));
  $('#xpFill').style.width = pct + '%';
  $('#statTotal').textContent = state.cleanDates.length;
  $('#statRelapses').textContent = state.relapseDates.length;
  $('#statMilestones').textContent = state.unlocked.length;
  $('#lastUrge').textContent = state.urgeLogs.length ? formatTime(state.urgeLogs[state.urgeLogs.length-1].seconds) : '—';
  renderMilestoneList();
  renderJournalList();
  renderStatsList();
  saveState();
}

function renderMilestoneList(){
  const container = $('#milestoneList');
  container.innerHTML = '';
  const streak = computeCurrentStreak();
  MILESTONES.forEach(ms=>{
    const unlocked = state.unlocked.includes(ms.day);
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div class="ms-pill ${unlocked ? 'ms-unlocked' : 'ms-locked'}">${ms.day}d</div>
      <div style="flex:1"><strong>${ms.title}</strong><div class="muted-sm">${ms.reality}</div></div></div>
      <div style="min-width:110px;text-align:right">
        <div class="muted-sm">${unlocked ? 'Unlocked' : (streak>=ms.day? 'Ready' : `Need ${ms.day-streak}d`)}</div>
      </div>`;
    container.appendChild(row);
  });
}

function renderJournalList(){
  const container = $('#journalList');
  container.innerHTML = '';
  const keys = Object.keys(state.journal).sort((a,b)=> b.localeCompare(a));
  if (!keys.length){ container.innerHTML = '<div class="item">No entries yet.</div>'; return; }
  keys.forEach(k=>{
    const div = document.createElement('div');
    div.className = 'item';
    const short = state.journal[k].length > 140 ? state.journal[k].slice(0,140)+'…' : state.journal[k];
    div.innerHTML = `<div style="text-align:left"><strong>${k}</strong><div class="muted-sm">${short}</div></div><div><button class="btn" data-date="${k}">Edit</button></div>`;
    container.appendChild(div);
  });
  $all('#journalList button').forEach(b=>{
    b.addEventListener('click', e=>{
      const d = e.target.dataset.date;
      const val = prompt(`Edit journal for ${d}`, state.journal[d]||'');
      if (val === null) return;
      saveJournal(d, val);
    });
  });
}

function renderStatsList(){
  const cur = computeCurrentStreak();
  const stats = [
    {k:'Current streak', v: cur},
    {k:'Highest streak', v: state.highestStreak || computeHighestStreak()},
    {k:'Total clean days', v: state.cleanDates.length},
    {k:'Relapses logged', v: state.relapseDates.length},
    {k:'Level', v: state.level},
    {k:'XP (current level)', v: state.xp},
    {k:'Unlocked milestones', v: state.unlocked.length},
    {k:'Urge sessions logged', v: state.urgeLogs.length},
  ];
  const container = $('#statsList'); container.innerHTML = '';
  stats.forEach(s=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="text-align:left"><strong>${s.k}</strong><div class="muted-sm">${s.v}</div></div>`;
    container.appendChild(it);
  });
}

// ---------- Modals & UI events ----------
function openModal(id){ $(id).style.display='flex'; }
function closeModal(id){ $(id).style.display='none'; }

function showUnlock(title, desc){
  $('#unlockTitle').textContent = title;
  $('#unlockDesc').textContent = '';
  // desc may contain newlines
  const dvals = desc.split('\n').map(l=>l.trim()).filter(Boolean);
  $('#unlockDesc').innerHTML = dvals.map(l=>`<div class="muted-sm">${escapeHtml(l)}</div>`).join('');
  openModal('#modalMilestoneUnlock');
}

// ---------- escape helper ----------
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// ---------- Urge Timer ----------
let urgeTimer = null, urgeStart = null;
function startUrge(){
  if (urgeTimer) return;
  urgeStart = Date.now();
  $('#btnUrge').textContent = 'Stop Urge Timer';
  urgeTimer = setInterval(()=>{
    const s = Math.floor((Date.now()-urgeStart)/1000);
    $('#btnUrge').textContent = `Stop Urge — ${formatTime(s)}`;
  }, 500);
}
function stopUrge(){
  if (!urgeTimer) return;
  const seconds = Math.round((Date.now()-urgeStart)/1000);
  clearInterval(urgeTimer); urgeTimer=null; urgeStart=null;
  $('#btnUrge').textContent = 'Start Urge Timer';
  saveUrge(seconds);
  alert(`Urge recorded: ${formatTime(seconds)} — well done.`);
}
function formatTime(s){ if (s<60) return s+'s'; const m=Math.floor(s/60), r=s%60; return `${m}m ${r}s`; }

// ---------- Breathing (box 4-4-4-4) ----------
let breathInterval = null, breathPhase = 0;
function startBreathing(){
  if (breathInterval) return;
  breathPhase = 0; let sec = 4;
  $('#breathText').textContent = `Inhale • ${sec}`;
  $('#breathRing').style.transform='scale(.85)';
  breathInterval = setInterval(()=>{
    sec--;
    if (sec<=0){
      breathPhase = (breathPhase+1)%4; sec=4;
      if (breathPhase===0){ $('#breathRing').style.transform='scale(1.1)'; $('#breathText').textContent='Inhale • 4'; }
      if (breathPhase===1){ $('#breathRing').style.transform='scale(1.05)'; $('#breathText').textContent='Hold • 4'; }
      if (breathPhase===2){ $('#breathRing').style.transform='scale(.8)'; $('#breathText').textContent='Exhale • 4'; }
      if (breathPhase===3){ $('#breathRing').style.transform='scale(.95)'; $('#breathText').textContent='Hold • 4'; }
    } else {
      const phases=['Inhale','Hold','Exhale','Hold']; $('#breathText').textContent = `${phases[breathPhase]} • ${sec}`;
    }
  },1000);
}
function stopBreathing(){ if (breathInterval) clearInterval(breathInterval); breathInterval=null; $('#breathRing').style.transform='scale(1)'; $('#breathText').textContent='Breathing stopped'; }

// ---------- Export / Import ----------
function exportData(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'trak_recovery_backup.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  alert('Exported data file. Save it somewhere safe.');
}
function importDataFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const parsed = JSON.parse(e.target.result);
      // basic validation
      if (!parsed || typeof parsed !== 'object') throw new Error('Invalid file');
      if (!confirm('Importing will overwrite local app data. Continue?')) return;
      state = {...defaultState, ...parsed};
      saveState(); renderAll();
      alert('Import complete.');
    }catch(err){ alert('Import failed: '+err.message); }
  };
  reader.readAsText(file);
}

// ---------- Reset app ----------
function resetApp(){
  if (!confirm('This will erase ALL progress and journals on this device. Are you sure?')) return;
  localStorage.removeItem(STORAGE_KEY);
  state = loadState();
  renderAll();
  alert('App reset. Fresh start.');
}

// ---------- Utilities for UI wiring ----------
function setDefaultDates(){
  const d = todayKey();
  $('#logDate').value = d;
  $('#relapseDate').value = d;
}

// ---------- Event wiring ----------
function setupListeners(){
  // buttons
  $('#btnLogClean').addEventListener('click', ()=>{
    const d = $('#logDate').value || todayKey();
    const ok = logClean(d);
    if (ok) alert('Clean day logged ✓');
    else alert('This day is already marked clean.');
  });

  $('#btnRelapse').addEventListener('click', ()=>{
    const d = $('#relapseDate').value || todayKey();
    if (!confirm('Log relapse on '+d+'? This will reset streaks from that day.')) return;
    logRelapse(d);
    alert('Relapse logged — now get back on it.');
  });

  $('#btnEmergency').addEventListener('click', ()=> openModal('#modalEmergency'));
  $('#closeEmergency').addEventListener('click', ()=> { stopBreathing(); closeModal('#modalEmergency'); });
  $('#startBreath').addEventListener('click', ()=> startBreathing());
  $('#stopBreath').addEventListener('click', ()=> stopBreathing());
  $('#quickQuote').addEventListener('click', ()=> alert(['Urges pass — breathe and wait.','You are stronger than a moment.','Your future self thanks you.'][Math.floor(Math.random()*3)]));

  $('#btnUrge').addEventListener('click', ()=> { if (!urgeTimer) startUrge(); else stopUrge(); });

  $('#btnSaveJournal').addEventListener('click', ()=>{
    const txt = $('#journalText').value || '';
    const d = $('#logDate').value || todayKey();
    saveJournal(d, txt);
    alert('Journal saved for ' + d);
  });

  $('#btnViewJournals').addEventListener('click', ()=> openModal('#modalJournals'));
  $('#closeJournals').addEventListener('click', ()=> closeModal('#modalJournals'));

  $('#btnOpenMilestones').addEventListener('click', ()=> openModal('#modalMilestones'));
  $('#closeMilestones').addEventListener('click', ()=> closeModal('#modalMilestones'));
  $('#closeUnlock').addEventListener('click', ()=> closeModal('#modalMilestoneUnlock'));

  $('#btnOpenStats').addEventListener('click', ()=> openModal('#modalStats'));
  $('#closeStats').addEventListener('click', ()=> closeModal('#modalStats'));

  $('#tabHome').addEventListener('click', ()=> { activateTab('home'); });
  $('#tabMilestones').addEventListener('click', ()=> { activateTab('milestones'); openModal('#modalMilestones'); });
  $('#tabJournal').addEventListener('click', ()=> { activateTab('journal'); openModal('#modalJournals'); });
  $('#tabSettings').addEventListener('click', ()=> { activateTab('settings'); openModal('#modalStats'); });

  $('#btnExport').addEventListener('click', exportData);
  $('#btnImport').addEventListener('click', ()=> $('#fileImport').click());
  $('#fileImport').addEventListener('change', e=> { if (e.target.files && e.target.files[0]) importDataFile(e.target.files[0]); });
  $('#btnResetApp').addEventListener('click', resetApp);
}

// tab UI
function activateTab(name){
  $all('.tab').forEach(t=>t.classList.remove('active'));
  if (name==='home') $('#tabHome').classList.add('active');
  if (name==='milestones') $('#tabMilestones').classList.add('active');
  if (name==='journal') $('#tabJournal').classList.add('active');
  if (name==='settings') $('#tabSettings').classList.add('active');
}

// ---------- Init ----------
setDefaultDates();
setupListeners();
checkMilestones(); // in case some are already achieved
renderAll();
saveState();
</script>
</body>
</html>
